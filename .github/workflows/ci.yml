# Quackito CI/CD Pipeline
#
# On every PR to main: Lint → Test (client + server in parallel)
# On push to main: Lint → Test → Build & Push images to GHCR → Update Helm values

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  CLIENT_IMAGE: ghcr.io/${{ github.repository_owner }}/quackito-client
  SERVER_IMAGE: ghcr.io/${{ github.repository_owner }}/quackito-server

jobs:
  # ── Client ────────────────────────────────────────
  lint-client:
    name: Lint Client
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: client/package-lock.json
      - run: npm ci
      - run: npm run lint

  test-client:
    name: Test Client
    runs-on: ubuntu-latest
    needs: lint-client
    defaults:
      run:
        working-directory: client
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: client/package-lock.json
      - run: npm ci
      - run: npm test

  # ── Server ────────────────────────────────────────
  lint-server:
    name: Lint Server
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: server/package-lock.json
      - run: npm ci
      - run: npm run lint

  test-server:
    name: Test Server
    runs-on: ubuntu-latest
    needs: lint-server
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: server/package-lock.json
      - run: npm ci
      - run: npm test

  # ── Build & Push Docker Images to GHCR ────────────
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [test-client, test-server]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push client image
        uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: |
            ${{ env.CLIENT_IMAGE }}:${{ github.sha }}

      - name: Build & push server image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: |
            ${{ env.SERVER_IMAGE }}:${{ github.sha }}

  # ── Update Helm values with new image tags ────────
  update-helm-tags:
    name: Update Helm Image Tags
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tags in values.yaml
        run: |
          cd helm/quackito
          sed -i 's|^\(    tag:\).*# client-tag|    tag: "${{ github.sha }}"  # client-tag|' values.yaml
          sed -i 's|^\(    tag:\).*# server-tag|    tag: "${{ github.sha }}"  # server-tag|' values.yaml

      - name: Commit and push updated tags
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add helm/quackito/values.yaml
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "ci: update image tags to ${{ github.sha }}"
          git push
